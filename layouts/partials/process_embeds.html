{{- /*
  Post-processor for .Content to embed YouTube/Spotify links when
  render hooks arenâ€™t applied (e.g., Micro.blog pipeline differences).
  Replaces common anchor/bare-URL patterns with responsive iframes.
*/ -}}

{{- $c := . -}}

{{/* ---------- YouTube (anchor) ---------- */}}
{{- $c = replaceRE `<p>\s*<a[^>]+href="https?://(?:www\.)?youtube\.com/watch\?[^"<>]*v=([A-Za-z0-9_-]{11})[^"<>]*"[^>]*>.*?</a>\s*</p>` `<div class="embed embed-16by9"><iframe src="https://www.youtube.com/embed/$1" title="YouTube video" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe></div>` $c -}}
{{- $c = replaceRE `<p>\s*<a[^>]+href="https?://(?:www\.)?youtu\.be/([A-Za-z0-9_-]{11})(?:\?[^"<>]*)?"[^>]*>.*?</a>\s*</p>` `<div class="embed embed-16by9"><iframe src="https://www.youtube.com/embed/$1" title="YouTube video" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe></div>` $c -}}
{{- $c = replaceRE `<p>\s*<a[^>]+href="https?://(?:www\.)?youtube\.com/shorts/([A-Za-z0-9_-]{11})(?:\?[^"<>]*)?"[^>]*>.*?</a>\s*</p>` `<div class="embed embed-16by9"><iframe src="https://www.youtube.com/embed/$1" title="YouTube video" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe></div>` $c -}}

{{/* ---------- YouTube (bare URL in paragraph) ---------- */}}
{{- $c = replaceRE `<p>\s*https?://(?:www\.)?youtube\.com/watch\?[^<]*v=([A-Za-z0-9_-]{11})[^<]*\s*</p>` `<div class="embed embed-16by9"><iframe src="https://www.youtube.com/embed/$1" title="YouTube video" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe></div>` $c -}}
{{- $c = replaceRE `<p>\s*https?://(?:www\.)?youtu\.be/([A-Za-z0-9_-]{11})(?:\?[^<]*)?\s*</p>` `<div class="embed embed-16by9"><iframe src="https://www.youtube.com/embed/$1" title="YouTube video" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe></div>` $c -}}
{{- $c = replaceRE `<p>\s*https?://(?:www\.)?youtube\.com/shorts/([A-Za-z0-9_-]{11})(?:\?[^<]*)?\s*</p>` `<div class="embed embed-16by9"><iframe src="https://www.youtube.com/embed/$1" title="YouTube video" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe></div>` $c -}}

{{/* ---------- Spotify (anchor) ---------- */}}
{{- $c = replaceRE `<p>\s*<a[^>]+href="https?://open\.spotify\.com/(?:intl-[^/]+/)?(album|track|playlist|episode|show)/([A-Za-z0-9]+)[^"<>]*"[^>]*>.*?</a>\s*</p>` `<iframe style="width:100%; height: 380px; border: 0;" src="https://open.spotify.com/embed/$1/$2" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>` $c -}}

{{/* ---------- Spotify (bare URL in paragraph) ---------- */}}
{{- $c = replaceRE `<p>\s*https?://open\.spotify\.com/(?:intl-[^/]+/)?(album|track|playlist|episode|show)/([A-Za-z0-9]+)[^<]*\s*</p>` `<iframe style="width:100%; height: 380px; border: 0;" src="https://open.spotify.com/embed/$1/$2" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>` $c -}}

{{- $c | safeHTML -}}
